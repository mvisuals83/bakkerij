<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ü•ñ Bakkerij Planning</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#0f172a">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600&family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Supabase CDN -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <style>
        :root {
            --bg-darkest: #0f172a;
            --bg-dark: #1e293b;
            --bg-card: #334155;
            --bg-input: #475569;
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --text-muted: #64748b;
            --accent-blue: #3b82f6;
            --accent-cyan: #06b6d4;
            --accent-green: #10b981;
            --accent-orange: #f97316;
            --accent-red: #ef4444;
            --border-color: #475569;
            --border-light: #334155;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3);
            --radius: 12px;
            --radius-sm: 8px;
            --font-sans: 'Plus Jakarta Sans', -apple-system, sans-serif;
            --font-mono: 'JetBrains Mono', monospace;
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        input[type="number"]::-webkit-inner-spin-button,
        input[type="number"]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        input[type="number"] { -moz-appearance: textfield; }
        
        html, body {
            font-family: var(--font-sans);
            background: var(--bg-darkest);
            color: var(--text-primary);
            min-height: 100vh;
        }
        
        .header {
            background: linear-gradient(135deg, var(--bg-dark), var(--bg-darkest));
            padding: 12px 16px;
            border-bottom: 1px solid var(--border-light);
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .logo { font-size: 1.3rem; font-weight: 700; display: flex; align-items: center; gap: 8px; }
        
        .date-nav { display: flex; align-items: center; gap: 6px; }
        
        .date-btn {
            width: 36px; height: 36px; border-radius: 50%; border: none;
            background: var(--bg-card); color: var(--text-primary);
            font-size: 1.1rem; cursor: pointer;
            display: flex; align-items: center; justify-content: center;
        }
        
        .current-date { text-align: center; min-width: 120px; }
        .current-date .day { font-size: 1rem; font-weight: 600; }
        .current-date .date { font-size: 0.8rem; color: var(--text-secondary); }
        
        .weekend-badge {
            background: linear-gradient(135deg, var(--accent-orange), var(--accent-red));
            color: white; padding: 2px 8px; border-radius: 20px;
            font-size: 0.65rem; font-weight: 600; margin-left: 6px;
        }
        
        .weather-badge {
            background: var(--bg-card);
            color: var(--text-primary); padding: 4px 8px; border-radius: 20px;
            font-size: 0.75rem; margin-left: 6px;
            display: inline-flex; align-items: center; gap: 4px;
            border: 1px solid var(--border-color);
        }
        
        .header-controls { display: flex; gap: 10px; align-items: center; }
        
        .event-select {
            background: var(--bg-card); border: 1px solid var(--border-color);
            color: var(--text-primary); padding: 6px 10px; border-radius: var(--radius-sm);
            font-size: 0.85rem;
        }
        
        .save-btn {
            background: linear-gradient(135deg, var(--accent-blue), var(--accent-cyan));
            border: none; color: white; padding: 8px 16px; border-radius: var(--radius-sm);
            font-weight: 600; font-size: 0.9rem; cursor: pointer;
            display: flex; align-items: center; gap: 6px;
            transition: all 0.3s ease;
        }
        
        .save-btn.unsaved {
            background: linear-gradient(135deg, var(--accent-red), var(--accent-orange));
            animation: pulse-unsaved 2s infinite;
        }
        
        .save-btn.saved {
            background: linear-gradient(135deg, var(--accent-green), #059669);
        }
        
        @keyframes pulse-unsaved {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        .tabs {
            display: flex; background: var(--bg-dark);
            border-bottom: 1px solid var(--border-light);
            overflow-x: auto;
        }
        
        .tab {
            flex: 1; min-width: 70px; padding: 12px 8px;
            background: transparent; border: none; color: var(--text-secondary);
            font-size: 0.8rem; font-weight: 500; cursor: pointer;
            position: relative; white-space: nowrap;
        }
        
        .tab.active { color: var(--accent-blue); }
        .tab.active::after {
            content: ''; position: absolute; bottom: 0; left: 0; right: 0;
            height: 3px; background: var(--accent-blue);
        }
        
        .main { padding: 12px; padding-bottom: 100px; }
        
        .page { display: none; }
        .page.active { display: block; }
        
        .group-card {
            background: var(--bg-dark); border-radius: var(--radius);
            margin-bottom: 12px; overflow: hidden;
            border: 1px solid var(--border-light);
        }
        
        .group-header {
            padding: 10px 12px; font-weight: 600; font-size: 0.85rem;
            display: flex; align-items: center; gap: 6px;
        }
        
        .group-header.group-a {
            background: linear-gradient(135deg, rgba(249, 115, 22, 0.2), rgba(239, 68, 68, 0.1));
            color: var(--accent-orange);
        }
        
        .group-header.group-b {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.2), rgba(6, 182, 212, 0.1));
            color: var(--accent-cyan);
        }
        
        .table-wrapper {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        .planning-table {
            width: 100%; min-width: 380px; border-collapse: collapse;
        }
        
        .planning-table th {
            padding: 6px 3px; font-size: 0.65rem; font-weight: 600;
            text-transform: uppercase; color: var(--text-muted);
            text-align: center; background: var(--bg-card);
        }
        
        .planning-table th:first-child { text-align: left; padding-left: 8px; }
        
        .planning-table td {
            padding: 5px 3px; text-align: center;
            border-bottom: 1px solid var(--border-light);
        }
        
        .planning-table td:first-child {
            text-align: left; padding-left: 8px;
            font-weight: 500; font-size: 0.75rem;
        }
        
        .planning-table .total-row { background: var(--bg-card); font-weight: 600; }
        
        .planning-table input {
            width: 34px; padding: 5px 2px;
            background: var(--bg-input); border: 1px solid var(--border-color);
            border-radius: 4px; color: var(--text-primary);
            font-family: var(--font-mono); font-size: 0.85rem; text-align: center;
        }
        
        .planning-table input:focus { outline: none; border-color: var(--accent-blue); }
        
        .planning-table .sug-value {
            color: var(--text-secondary); font-family: var(--font-mono); font-size: 0.85rem;
        }
        
        .lading-card {
            background: var(--bg-card); border-radius: var(--radius);
            padding: 12px; margin-bottom: 12px;
        }
        
        .lading-header { font-weight: 600; margin-bottom: 10px; font-size: 0.9rem; }
        
        .lading-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 6px; }
        
        .lading-item {
            text-align: center; padding: 8px 4px;
            background: var(--bg-dark); border-radius: var(--radius-sm);
        }
        
        .lading-item .label { font-size: 0.7rem; color: var(--text-muted); margin-bottom: 2px; }
        .lading-item .value { font-size: 1.2rem; font-weight: 700; font-family: var(--font-mono); color: var(--accent-blue); }
        .lading-item.warning .value { color: var(--accent-orange); }
        .lading-item.danger .value { color: var(--accent-red); }
        
        .reference-card {
            background: var(--bg-dark); border-radius: var(--radius);
            padding: 12px; margin-top: 16px;
        }
        
        .reference-header { font-weight: 600; margin-bottom: 10px; color: var(--text-secondary); font-size: 0.85rem; }
        
        .reference-table { width: 100%; border-collapse: collapse; font-size: 0.8rem; }
        .reference-table th { padding: 6px; font-size: 0.65rem; color: var(--text-muted); text-align: center; }
        .reference-table th:first-child { text-align: left; }
        .reference-table td { padding: 5px; text-align: center; font-family: var(--font-mono); }
        .reference-table td:first-child { text-align: left; font-family: var(--font-sans); }
        .reference-table .breuk { color: var(--accent-red); font-weight: 600; }
        
        .breuk-date-selector { background: var(--bg-dark); border-radius: var(--radius); padding: 12px; margin-bottom: 12px; }
        .breuk-date-selector label { font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 6px; display: block; }
        .breuk-date-selector select { width: 100%; padding: 10px; background: var(--bg-card); border: 1px solid var(--border-color); border-radius: var(--radius-sm); color: var(--text-primary); }
        
        .breuk-grid { display: grid; gap: 10px; }
        .breuk-item { background: var(--bg-dark); border-radius: var(--radius); padding: 12px; display: flex; justify-content: space-between; align-items: center; }
        .breuk-item .product-name { font-weight: 600; margin-bottom: 2px; }
        .breuk-item .product-baked { font-size: 0.8rem; color: var(--text-secondary); }
        .breuk-item input { width: 70px; padding: 10px; background: var(--bg-card); border: 2px solid var(--border-color); border-radius: var(--radius-sm); color: var(--accent-red); font-family: var(--font-mono); font-size: 1.1rem; font-weight: 600; text-align: center; }
        
        .breuk-save-btn { width: 100%; padding: 14px; margin-top: 12px; background: linear-gradient(135deg, var(--accent-green), #059669); border: none; border-radius: var(--radius); color: white; font-size: 1rem; font-weight: 600; cursor: pointer; }
        
        .stats-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-bottom: 16px; }
        .stat-card { background: var(--bg-dark); border-radius: var(--radius); padding: 12px; }
        .stat-card .label { font-size: 0.75rem; color: var(--text-muted); margin-bottom: 2px; }
        .stat-card .value { font-size: 1.3rem; font-weight: 700; font-family: var(--font-mono); }
        .stat-card.green .value { color: var(--accent-green); }
        .stat-card.red .value { color: var(--accent-red); }
        .stat-card.blue .value { color: var(--accent-blue); }
        .stat-card.orange .value { color: var(--accent-orange); }
        
        .history-table { width: 100%; background: var(--bg-dark); border-radius: var(--radius); overflow: hidden; }
        .history-table th { padding: 10px; background: var(--bg-card); font-size: 0.75rem; text-align: left; color: var(--text-secondary); }
        .history-table td { padding: 10px; border-bottom: 1px solid var(--border-light); font-family: var(--font-mono); font-size: 0.85rem; }
        
        .settings-section { background: var(--bg-dark); border-radius: var(--radius); padding: 14px; margin-bottom: 12px; }
        .settings-section h3 { font-size: 0.95rem; margin-bottom: 12px; color: var(--text-secondary); }
        .setting-row { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid var(--border-light); }
        .setting-row:last-child { border-bottom: none; }
        .setting-row input[type="number"] { width: 70px; padding: 6px; background: var(--bg-card); border: 1px solid var(--border-color); border-radius: var(--radius-sm); color: var(--text-primary); font-family: var(--font-mono); text-align: center; }
        
        .toggle { position: relative; width: 46px; height: 26px; }
        .toggle input { opacity: 0; width: 0; height: 0; }
        .toggle-slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background: var(--bg-input); border-radius: 26px; transition: 0.3s; }
        .toggle-slider::before { content: ''; position: absolute; height: 20px; width: 20px; left: 3px; bottom: 3px; background: white; border-radius: 50%; transition: 0.3s; }
        .toggle input:checked + .toggle-slider { background: var(--accent-green); }
        .toggle input:checked + .toggle-slider::before { transform: translateX(20px); }
        
        .toast { position: fixed; bottom: 80px; left: 50%; transform: translateX(-50%) translateY(100px); background: var(--bg-card); color: var(--text-primary); padding: 12px 20px; border-radius: var(--radius); opacity: 0; transition: all 0.3s; z-index: 1000; }
        .toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }
        .toast.success { border-left: 4px solid var(--accent-green); }
        
        .range-btn { padding: 8px 12px; background: var(--bg-card); border: 1px solid var(--border-color); border-radius: var(--radius-sm); color: var(--text-secondary); font-size: 0.8rem; cursor: pointer; transition: all 0.2s; }
        .range-btn:hover { background: var(--bg-hover); color: var(--text-primary); }
        .range-btn.active { background: var(--accent-blue); color: white; border-color: var(--accent-blue); }
        
        @media (max-width: 400px) {
            .save-btn span { display: none; }
            .planning-table { min-width: 360px; }
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="header-top">
            <div class="logo">ü•ñ Bakkerij</div>
            <div class="date-nav">
                <button class="date-btn" onclick="changeDate(-1)">‚Äπ</button>
                <div class="current-date">
                    <div class="day" id="current-day">zaterdag</div>
                    <div class="date" id="current-date">06/12/2025</div>
                </div>
                <button class="date-btn" onclick="changeDate(1)">‚Ä∫</button>
                <span class="weekend-badge" id="weekend-badge" style="display: none;">WEEKEND</span>
            </div>
        </div>
        <div class="header-controls">
            <span class="weather-badge" id="weather-badge" title="Weer voorspelling">--</span>
            <select class="event-select" id="event-select" onchange="onEventChange()">
                <option value="Normal">Normal</option>
                <option value="Sneeuw">‚ùÑÔ∏è Sneeuw</option>
                <option value="BBQ">‚òÄÔ∏è BBQ Weer</option>
                <option value="Feestdag">üéâ Feestdag</option>
                <option value="Promo">üì¢ Promo</option>
            </select>
            <button class="save-btn" id="save-btn" onclick="savePlanning()">üíæ <span>Opslaan</span></button>
        </div>
    </header>
    
    <nav class="tabs">
        <button class="tab active" data-page="planning">üìã Planning</button>
        <button class="tab" data-page="breuk">üìä Breuk</button>
        <button class="tab" data-page="historiek">üìà Historiek</button>
        <button class="tab" data-page="instellingen">‚öôÔ∏è Instellingen</button>
    </nav>
    
    <main class="main">
        <div class="page active" id="page-planning">
            <div class="group-card">
                <div class="group-header group-a">üî∂ GROEP A ‚Äî Pistolets</div>
                <div class="table-wrapper">
                    <table class="planning-table">
                        <thead>
                            <tr><th>Product</th><th>Sug</th><th>Totaal</th><th>L1</th><th>L2</th><th>L3</th><th>L4</th><th>L5</th></tr>
                        </thead>
                        <tbody id="group-a-body"></tbody>
                    </table>
                </div>
            </div>
            
            <div class="group-card">
                <div class="group-header group-b">üî∑ GROEP B ‚Äî Stokbrood</div>
                <div class="table-wrapper">
                    <table class="planning-table">
                        <thead>
                            <tr><th>Product</th><th>Sug</th><th>Totaal</th><th>L1</th><th>L2</th><th>L3</th><th>L4</th><th>L5</th></tr>
                        </thead>
                        <tbody id="group-b-body"></tbody>
                    </table>
                </div>
            </div>
            
            <div class="lading-card">
                <div class="lading-header">üì¶ Totaal Lading</div>
                <div class="lading-grid">
                    <div class="lading-item"><div class="label">L1</div><div class="value" id="lading-l1">0</div></div>
                    <div class="lading-item"><div class="label">L2</div><div class="value" id="lading-l2">0</div></div>
                    <div class="lading-item"><div class="label">L3</div><div class="value" id="lading-l3">0</div></div>
                    <div class="lading-item"><div class="label">L4</div><div class="value" id="lading-l4">0</div></div>
                    <div class="lading-item"><div class="label">L5</div><div class="value" id="lading-l5">0</div></div>
                </div>
            </div>
            
            <div class="reference-card">
                <div class="reference-header">üìä Vorige Weken (zelfde dag)</div>
                <table class="reference-table">
                    <thead><tr><th>Product</th><th>W-1</th><th>Brk</th><th>W-2</th><th>Brk</th><th>W-3</th><th>Brk</th></tr></thead>
                    <tbody id="reference-body"></tbody>
                </table>
            </div>
        </div>
        
        <div class="page" id="page-breuk">
            <div class="breuk-date-selector">
                <label>Selecteer datum:</label>
                <select id="breuk-date-select" onchange="loadBreukData()"></select>
            </div>
            <div class="breuk-grid" id="breuk-grid"></div>
            <button class="breuk-save-btn" onclick="saveBreuk()">‚úÖ Breuk Opslaan</button>
        </div>
        
        <div class="page" id="page-historiek">
            <div class="settings-section" style="margin-bottom: 12px;">
                <div style="display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 10px;">
                    <button class="range-btn active" data-range="7" onclick="setHistoryRange(7)">7 dagen</button>
                    <button class="range-btn" data-range="14" onclick="setHistoryRange(14)">14 dagen</button>
                    <button class="range-btn" data-range="30" onclick="setHistoryRange(30)">Deze maand</button>
                    <button class="range-btn" data-range="all" onclick="setHistoryRange('all')">Alles</button>
                    <button class="range-btn" data-range="custom" onclick="setHistoryRange('custom')">Aangepast</button>
                </div>
                <div id="custom-date-range" style="display: none; margin-top: 10px;">
                    <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
                        <label style="font-size: 0.85rem; color: var(--text-secondary);">Van:</label>
                        <input type="date" id="history-date-from" onchange="applyCustomDateRange()" style="padding: 8px; background: var(--bg-card); border: 1px solid var(--border-color); border-radius: var(--radius-sm); color: var(--text-primary);">
                        <label style="font-size: 0.85rem; color: var(--text-secondary);">Tot:</label>
                        <input type="date" id="history-date-to" onchange="applyCustomDateRange()" style="padding: 8px; background: var(--bg-card); border: 1px solid var(--border-color); border-radius: var(--radius-sm); color: var(--text-primary);">
                    </div>
                </div>
            </div>
            <div class="stats-grid">
                <div class="stat-card green"><div class="label">Totaal Gebakken</div><div class="value" id="stat-gebakken">0</div></div>
                <div class="stat-card blue"><div class="label">Verkocht</div><div class="value" id="stat-verkocht">0</div></div>
                <div class="stat-card red"><div class="label">Totaal Breuk</div><div class="value" id="stat-breuk">0</div></div>
                <div class="stat-card orange"><div class="label">Breuk %</div><div class="value" id="stat-percentage">0%</div></div>
            </div>
            <div class="stat-card" style="margin-bottom: 12px;">
                <div class="label" style="font-size: 0.9rem;">üí∞ Omzet (verkocht)</div>
                <div class="value" id="stat-omzet" style="font-size: 1.8rem; color: var(--accent-green);">‚Ç¨0.00</div>
            </div>
            <div class="settings-section" style="margin-bottom: 12px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                    <h3>üìà Trend</h3>
                    <select id="chart-product-select" onchange="renderHistoriek()" style="padding: 6px 10px; background: var(--bg-card); border: 1px solid var(--border-color); border-radius: var(--radius-sm); color: var(--text-primary); font-size: 0.85rem;">
                        <option value="all">Alle producten</option>
                        <option value="pistolet_wit">Pist. wit</option>
                        <option value="pistolet_bruin">Pist. bruin</option>
                        <option value="tijger_pistolet">Tijger</option>
                        <option value="piccolo">Piccolo</option>
                        <option value="stokbrood_wit">Stok. wit</option>
                        <option value="stokbrood_bruin">Stok. bruin</option>
                    </select>
                </div>
                <div style="height: 180px; position: relative;">
                    <canvas id="chart-canvas" style="width: 100%; height: 100%;"></canvas>
                </div>
                <div style="display: flex; justify-content: center; gap: 16px; margin-top: 6px; font-size: 0.7rem;">
                    <span style="color: var(--accent-green);">‚óè Gebakken</span>
                    <span style="color: var(--accent-red);">‚óè Breuk</span>
                </div>
            </div>
            <table class="history-table">
                <thead><tr><th>Product</th><th>Gebakken</th><th>Verkocht</th><th>Omzet</th><th>Breuk</th><th>%</th></tr></thead>
                <tbody id="history-body"></tbody>
            </table>
        </div>
        
        <div class="page" id="page-instellingen">
            <div class="settings-section">
                <h3>‚öôÔ∏è Capaciteit</h3>
                <div class="setting-row"><label>Oven 1 max</label><input type="number" id="setting-oven1" value="16" onchange="saveCapacitySettings()"></div>
                <div class="setting-row"><label>Oven 2 max</label><input type="number" id="setting-oven2" value="15" onchange="saveCapacitySettings()"></div>
                <div class="setting-row"><label>Batch max</label><input type="number" id="setting-batch-max" value="31" onchange="saveCapacitySettings()"></div>
            </div>
            <div class="settings-section">
                <h3>üî• Weekend Strategie</h3>
                <div class="setting-row">
                    <label>Skip Groep B in L2</label>
                    <label class="toggle"><input type="checkbox" id="setting-skip-b" checked onchange="saveCapacitySettings()"><span class="toggle-slider"></span></label>
                </div>
            </div>
            <div class="settings-section">
                <h3>üí∞ Prijzen</h3>
                <div class="setting-row"><label>Groep A (Pistolets)</label><span style="color: var(--text-muted);">‚Ç¨</span><input type="number" step="0.01" id="setting-price-a" value="0.69" onchange="savePriceSettings()" style="width: 70px;"></div>
                <div class="setting-row"><label>Groep B (Stokbrood)</label><span style="color: var(--text-muted);">‚Ç¨</span><input type="number" step="0.01" id="setting-price-b" value="1.59" onchange="savePriceSettings()" style="width: 70px;"></div>
            </div>
            <div class="settings-section">
                <h3>ü•ñ Stuks per Plaat</h3>
                <div id="ppp-settings"></div>
            </div>
            <div class="settings-section">
                <h3>üìä Breuk Drempels</h3>
                <p style="font-size: 0.7rem; color: var(--text-muted); margin-bottom: 8px;">+Bij0 = extra als breuk=0 | -1/-2/-3 = verlagen bij breuk boven drempel</p>
                <div class="table-wrapper">
                    <table class="planning-table" style="min-width: 300px;">
                        <thead><tr><th>Product</th><th>+Bij0</th><th>-1&gt;</th><th>-2&gt;</th><th>-3&gt;</th></tr></thead>
                        <tbody id="drempel-settings"></tbody>
                    </table>
                </div>
            </div>
            <div class="settings-section" style="margin-top: 20px; opacity: 0.7;">
                <h3>‚òÅÔ∏è Database Status</h3>
                <div class="setting-row">
                    <span id="db-status">‚ö™ Controleren...</span>
                </div>
            </div>
        </div>
    </main>
    
    <div class="toast" id="toast"></div>
    
    <script>
        // ===== SUPABASE CONFIG =====
        const SUPABASE_URL = 'https://ukkvaewmnedznviqnotr.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVra3ZhZXdtbmVkem52aXFub3RyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUyODY5NjMsImV4cCI6MjA4MDg2Mjk2M30.J_2OPImNOrrBlwjztqRmUS7Qs9Y3RF1qT6D9x4-C5UE';
        let supabaseClient = null;
        
        // ===== DATA =====
        const PRODUCTS = [
            { id: 'pistolet_wit', name: 'pistolet wit', short: 'Pist. wit', group: 'A', ppp: 15, bij0: 1, d1: 30, d2: 60, d3: 90, price: 0.69 },
            { id: 'pistolet_bruin', name: 'pistolet bruin', short: 'Pist. bruin', group: 'A', ppp: 15, bij0: 1, d1: 20, d2: 40, d3: 60, price: 0.69 },
            { id: 'tijger_pistolet', name: 'tijger pistolet', short: 'Tijger', group: 'A', ppp: 15, bij0: 1, d1: 20, d2: 40, d3: 60, price: 0.69 },
            { id: 'piccolo', name: 'piccolo', short: 'Piccolo', group: 'A', ppp: 12, bij0: 1, d1: 20, d2: 40, d3: 60, price: 0.69 },
            { id: 'stokbrood_wit', name: 'stokbrood wit', short: 'Stok. wit', group: 'B', ppp: 5, bij0: 1, d1: 15, d2: 30, d3: 45, price: 1.59 },
            { id: 'stokbrood_bruin', name: 'stokbrood bruin', short: 'Stok. bruin', group: 'B', ppp: 4, bij0: 1, d1: 12, d2: 24, d3: 36, price: 1.59 }
        ];
        
        let SETTINGS = { oven1Max: 16, oven2Max: 15, batchMax: 31, skipBInL2: true, priceA: 0.69, priceB: 1.59 };
        let currentDate = new Date();
        let planningData = {};
        let historicalData = [];
        
        // Initial data
        const INITIAL_DATA = [
            { datum: '2025-11-29', product: 'pistolet wit', totaal: 45, l1: 10, l2: 20, l3: 10, l4: 5, l5: 0, breuk: 1, event: 'Normal' },
            { datum: '2025-11-29', product: 'pistolet bruin', totaal: 4, l1: 1, l2: 1, l3: 1, l4: 1, l5: 0, breuk: 0, event: 'Normal' },
            { datum: '2025-11-29', product: 'piccolo', totaal: 6, l1: 1, l2: 3, l3: 2, l4: 0, l5: 0, breuk: 0, event: 'Normal' },
            { datum: '2025-11-29', product: 'tijger pistolet', totaal: 6, l1: 2, l2: 2, l3: 1, l4: 1, l5: 0, breuk: 0, event: 'Normal' },
            { datum: '2025-11-29', product: 'stokbrood wit', totaal: 28, l1: 10, l2: 0, l3: 10, l4: 8, l5: 0, breuk: 1, event: 'Normal' },
            { datum: '2025-11-29', product: 'stokbrood bruin', totaal: 2, l1: 1, l2: 0, l3: 1, l4: 0, l5: 0, breuk: 5, event: 'Normal' },
            { datum: '2025-11-30', product: 'pistolet wit', totaal: 36, l1: 10, l2: 20, l3: 6, l4: 0, l5: 0, breuk: 0, event: 'Normal' },
            { datum: '2025-11-30', product: 'pistolet bruin', totaal: 4, l1: 1, l2: 2, l3: 1, l4: 0, l5: 0, breuk: 0, event: 'Normal' },
            { datum: '2025-11-30', product: 'piccolo', totaal: 6, l1: 2, l2: 2, l3: 2, l4: 0, l5: 0, breuk: 0, event: 'Normal' },
            { datum: '2025-11-30', product: 'tijger pistolet', totaal: 4, l1: 1, l2: 2, l3: 1, l4: 0, l5: 0, breuk: 0, event: 'Normal' },
            { datum: '2025-11-30', product: 'stokbrood wit', totaal: 14, l1: 7, l2: 0, l3: 7, l4: 0, l5: 0, breuk: 0, event: 'Normal' },
            { datum: '2025-11-30', product: 'stokbrood bruin', totaal: 2, l1: 1, l2: 0, l3: 1, l4: 0, l5: 0, breuk: 0, event: 'Normal' }
        ];
        
        // ===== UTILITIES =====
        function formatDate(d) { return `${String(d.getDate()).padStart(2,'0')}/${String(d.getMonth()+1).padStart(2,'0')}/${d.getFullYear()}`; }
        function formatDateISO(d) { return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`; }
        function getDayName(d) { return ['zondag','maandag','dinsdag','woensdag','donderdag','vrijdag','zaterdag'][d.getDay()]; }
        function isWeekend(d) { return d.getDay() === 0 || d.getDay() === 6; }
        function isSaturday(d) { return d.getDay() === 6; }
        
        function showToast(msg) {
            const t = document.getElementById('toast');
            t.textContent = msg;
            t.className = 'toast success show';
            setTimeout(() => t.classList.remove('show'), 3000);
        }
        
        // ===== CALCULATIONS =====
        function getSameWeekdayData(date, weeksAgo) {
            const target = new Date(date);
            target.setDate(target.getDate() - (weeksAgo * 7));
            return historicalData.filter(d => d.datum === formatDateISO(target));
        }
        
        function calculateSuggestion(product) {
            const lastWeek = getSameWeekdayData(currentDate, 1).find(d => d.product === product.name);
            if (!lastWeek) return 1;
            
            let sug = lastWeek.totaal;
            const breuk = lastWeek.breuk || 0;
            
            if (breuk === 0) sug += product.bij0;
            else if (breuk > product.d3) sug -= 3;
            else if (breuk > product.d2) sug -= 2;
            else if (breuk > product.d1) sug -= 1;
            
            return Math.max(1, sug);
        }
        
        function getGroupBatchLimits(isGroupA, isWeekendDay, skipL2) {
            // Returns max plates per batch for a group
            if (!isWeekendDay) {
                // Weekday: 2 batches only, split evenly
                return [50, 50, 0, 0, 0]; // High limits, will be constrained by totaal
            }
            
            if (isGroupA) {
                // Group A weekend: L1=14, L2=26 (extra when B skips), L3-L5=14
                return [14, skipL2 ? 26 : 14, 14, 14, 14];
            } else {
                // Group B weekend: L1=12, L2=0 (skip), L3-L5=13
                return [12, 0, 13, 13, 10];
            }
        }
        
        function distributeGroupToBatches(groupTotaal, limits) {
            // Distribute group total across batches according to limits
            const batches = [0, 0, 0, 0, 0];
            let remaining = groupTotaal;
            
            for (let i = 0; i < 5 && remaining > 0; i++) {
                batches[i] = Math.min(remaining, limits[i]);
                remaining -= batches[i];
            }
            
            // OPTIMIZATION: Move small remainders (1-3 plates) from later batches to earlier ones
            // This avoids wasting energy on nearly-empty batches
            for (let late = 4; late >= 2; late--) {
                if (batches[late] > 0 && batches[late] <= 3) {
                    // Try to move these plates to an earlier batch that has room
                    for (let early = 0; early < late; early++) {
                        const room = limits[early] - batches[early];
                        if (room >= batches[late]) {
                            // Move all plates from late batch to early batch
                            batches[early] += batches[late];
                            batches[late] = 0;
                            break;
                        }
                    }
                }
            }
            
            return batches;
        }
        
        function distributeProductsInBatches(products, groupBatches, productTotals, groupTotaal) {
            // Distribute each product proportionally within each batch
            const result = {};
            
            products.forEach(p => {
                result[p.id] = [0, 0, 0, 0, 0];
            });
            
            if (groupTotaal === 0) return result;
            
            for (let batch = 0; batch < 5; batch++) {
                const batchTotal = groupBatches[batch];
                if (batchTotal === 0) continue;
                
                let batchRemaining = batchTotal;
                const productShares = {};
                
                // Calculate proportional shares
                products.forEach(p => {
                    const ratio = productTotals[p.id] / groupTotaal;
                    productShares[p.id] = Math.round(batchTotal * ratio);
                });
                
                // Assign shares, ensuring we don't exceed product totals or batch total
                products.forEach(p => {
                    const productRemaining = productTotals[p.id] - result[p.id].reduce((a, b) => a + b, 0);
                    const share = Math.min(productShares[p.id], productRemaining, batchRemaining);
                    result[p.id][batch] = share;
                    batchRemaining -= share;
                });
                
                // If there's remaining capacity and products still need distribution, fill it
                if (batchRemaining > 0) {
                    for (const p of products) {
                        const productRemaining = productTotals[p.id] - result[p.id].reduce((a, b) => a + b, 0);
                        const extra = Math.min(productRemaining, batchRemaining);
                        result[p.id][batch] += extra;
                        batchRemaining -= extra;
                        if (batchRemaining <= 0) break;
                    }
                }
            }
            
            return result;
        }
        
        // ===== RENDERING =====
        function updateHeader() {
            document.getElementById('current-day').textContent = getDayName(currentDate);
            document.getElementById('current-date').textContent = formatDate(currentDate);
            const badge = document.getElementById('weekend-badge');
            badge.style.display = isWeekend(currentDate) ? 'inline-block' : 'none';
            badge.textContent = isSaturday(currentDate) ? 'ZATERDAG' : 'ZONDAG';
        }
        
        function renderPlanning() {
            const weekend = isWeekend(currentDate);
            const skipL2 = SETTINGS.skipBInL2;
            const batchMax = SETTINGS.batchMax;
            const dateStr = formatDateISO(currentDate);
            
            // Check if this date has saved data in historicalData
            const savedDayData = historicalData.filter(d => d.datum === dateStr);
            const hasSavedData = savedDayData.length > 0;
            
            // Load saved event if exists, otherwise default to 'Normal'
            const savedEvent = savedDayData[0]?.event || 'Normal';
            const eventSelect = document.getElementById('event-select');
            if (eventSelect && !planningData._eventEdited) {
                eventSelect.value = savedEvent;
            }
            
            // Build display data for each product
            const displayData = {};
            
            PRODUCTS.forEach(p => {
                const sug = calculateSuggestion(p);
                const savedRecord = savedDayData.find(d => d.product === p.name);
                const sessionEdit = planningData[p.id];
                
                // Priority: 1) Current session edits, 2) Saved data, 3) Suggestion
                if (sessionEdit && sessionEdit.totaal !== undefined) {
                    // User edited in this session
                    if (sessionEdit.l1 !== undefined) {
                        // User edited batches - use their values
                        displayData[p.id] = {
                            sug,
                            totaal: sessionEdit.totaal,
                            batches: [sessionEdit.l1, sessionEdit.l2, sessionEdit.l3, sessionEdit.l4, sessionEdit.l5]
                        };
                    } else {
                        // User only edited total - need to distribute
                        displayData[p.id] = {
                            sug,
                            totaal: sessionEdit.totaal,
                            batches: null // Will be calculated below
                        };
                    }
                } else if (savedRecord) {
                    // Load from saved data
                    displayData[p.id] = {
                        sug,
                        totaal: savedRecord.totaal,
                        batches: [savedRecord.l1 || 0, savedRecord.l2 || 0, savedRecord.l3 || 0, savedRecord.l4 || 0, savedRecord.l5 || 0]
                    };
                } else {
                    // Use suggestion
                    displayData[p.id] = {
                        sug,
                        totaal: sug,
                        batches: null // Will be calculated below
                    };
                }
            });
            
            // Calculate batches for products that need it (where batches is null)
            ['A', 'B'].forEach(group => {
                const products = PRODUCTS.filter(p => p.group === group);
                const isGroupA = group === 'A';
                
                // Check if any product in this group needs batch calculation
                const needsCalc = products.filter(p => displayData[p.id].batches === null);
                if (needsCalc.length === 0) return;
                
                // If some products have batches and some don't, calculate only for those that don't
                if (needsCalc.length < products.length) {
                    // Mixed: some saved, some new - distribute individually
                    needsCalc.forEach(p => {
                        const tot = displayData[p.id].totaal;
                        if (weekend) {
                            const limits = isGroupA ? [14, 26, 14, 14, 14] : [12, 0, 13, 13, 10];
                            displayData[p.id].batches = distributeSimple(tot, limits);
                        } else {
                            const l1 = Math.ceil(tot / 2);
                            displayData[p.id].batches = [l1, tot - l1, 0, 0, 0];
                        }
                    });
                } else {
                    // All products need calculation - use group distribution
                    let groupTotaal = 0;
                    const productTotals = {};
                    products.forEach(p => {
                        productTotals[p.id] = displayData[p.id].totaal;
                        groupTotaal += displayData[p.id].totaal;
                    });
                    
                    if (weekend) {
                        const limits = getGroupBatchLimits(isGroupA, weekend, skipL2);
                        const groupBatches = distributeGroupToBatches(groupTotaal, limits);
                        const productBatches = distributeProductsInBatches(products, groupBatches, productTotals, groupTotaal);
                        products.forEach(p => {
                            displayData[p.id].batches = productBatches[p.id];
                        });
                    } else {
                        products.forEach(p => {
                            const tot = displayData[p.id].totaal;
                            const l1 = Math.ceil(tot / 2);
                            displayData[p.id].batches = [l1, tot - l1, 0, 0, 0];
                        });
                    }
                }
            });
            
            // Fix rounding errors: ensure batches sum to totaal
            PRODUCTS.forEach(p => {
                const data = displayData[p.id];
                const batchSum = data.batches.reduce((a, b) => a + b, 0);
                if (batchSum !== data.totaal) {
                    // Adjust last non-zero batch
                    const diff = data.totaal - batchSum;
                    for (let i = 4; i >= 0; i--) {
                        if (data.batches[i] > 0 || i === 0) {
                            data.batches[i] += diff;
                            break;
                        }
                    }
                }
            });
            
            // Weekend optimization: move small remainders from late batches
            if (weekend) {
                const combinedTotals = [0, 0, 0, 0, 0];
                PRODUCTS.forEach(p => {
                    for (let i = 0; i < 5; i++) {
                        combinedTotals[i] += displayData[p.id].batches[i];
                    }
                });
                
                for (let late = 4; late >= 2; late--) {
                    if (combinedTotals[late] > 0 && combinedTotals[late] <= 3) {
                        for (let early = 0; early < late; early++) {
                            const room = batchMax - combinedTotals[early];
                            if (room >= combinedTotals[late]) {
                                PRODUCTS.forEach(p => {
                                    if (displayData[p.id].batches[late] > 0) {
                                        displayData[p.id].batches[early] += displayData[p.id].batches[late];
                                        displayData[p.id].batches[late] = 0;
                                    }
                                });
                                combinedTotals[early] += combinedTotals[late];
                                combinedTotals[late] = 0;
                                break;
                            }
                        }
                    }
                }
            }
            
            // Render both groups
            ['A', 'B'].forEach(group => {
                const body = document.getElementById(`group-${group.toLowerCase()}-body`);
                const products = PRODUCTS.filter(p => p.group === group);
                
                let html = '';
                let totals = { sug: 0, totaal: 0, l1: 0, l2: 0, l3: 0, l4: 0, l5: 0 };
                
                products.forEach(p => {
                    const data = displayData[p.id];
                    
                    totals.sug += data.sug;
                    totals.totaal += data.totaal;
                    for (let i = 0; i < 5; i++) totals[`l${i+1}`] += data.batches[i];
                    
                    html += `<tr>
                        <td>${p.short}</td>
                        <td class="sug-value">${data.sug}</td>
                        <td><input type="number" value="${data.totaal}" data-id="${p.id}" data-field="totaal" onchange="onInput(this)"></td>
                        <td><input type="number" value="${data.batches[0]}" data-id="${p.id}" data-field="l1" onchange="onInput(this)"></td>
                        <td><input type="number" value="${data.batches[1]}" data-id="${p.id}" data-field="l2" onchange="onInput(this)"></td>
                        <td><input type="number" value="${data.batches[2]}" data-id="${p.id}" data-field="l3" onchange="onInput(this)"></td>
                        <td><input type="number" value="${data.batches[3]}" data-id="${p.id}" data-field="l4" onchange="onInput(this)"></td>
                        <td><input type="number" value="${data.batches[4]}" data-id="${p.id}" data-field="l5" onchange="onInput(this)"></td>
                    </tr>`;
                });
                
                html += `<tr class="total-row">
                    <td>TOTAAL ${group}</td><td>${totals.sug}</td><td>${totals.totaal}</td>
                    <td>${totals.l1}</td><td>${totals.l2}</td><td>${totals.l3}</td><td>${totals.l4}</td><td>${totals.l5}</td>
                </tr>`;
                body.innerHTML = html;
            });
            
            // Update lading totals
            for (let i = 1; i <= 5; i++) {
                let total = 0;
                document.querySelectorAll(`input[data-field="l${i}"]`).forEach(inp => {
                    total += parseInt(inp.value) || 0;
                });
                const el = document.getElementById(`lading-l${i}`);
                el.textContent = total;
                el.parentElement.className = 'lading-item' + (total > SETTINGS.batchMax ? ' danger' : total > 25 ? ' warning' : '');
            }
            
            renderReference();
        }
        
        // Simple distribution for single product
        function distributeSimple(totaal, limits) {
            const batches = [0, 0, 0, 0, 0];
            let remaining = totaal;
            for (let i = 0; i < 5 && remaining > 0; i++) {
                batches[i] = Math.min(remaining, limits[i]);
                remaining -= batches[i];
            }
            return batches;
        }
        
        function renderReference() {
            let html = '';
            
            // First add the weather row
            html += '<tr style="background: var(--bg-card);"><td style="font-weight: 600;">Weer</td>';
            for (let w = 1; w <= 3; w++) {
                const weekData = getSameWeekdayData(currentDate, w);
                const weather = weekData[0]?.weather || '--';
                html += `<td colspan="2" style="text-align: center; font-size: 0.8rem;">${weather}</td>`;
            }
            html += '</tr>';
            
            // Add the event row
            html += '<tr style="background: var(--bg-card);"><td style="font-weight: 600;">Event</td>';
            for (let w = 1; w <= 3; w++) {
                const weekData = getSameWeekdayData(currentDate, w);
                const event = weekData[0]?.event || 'Normal';
                const eventIcons = {
                    'Normal': '',
                    'Sneeuw': '‚ùÑÔ∏è',
                    'BBQ': '‚òÄÔ∏è',
                    'Feestdag': 'üéâ',
                    'Promo': 'üì¢'
                };
                const icon = eventIcons[event] || '';
                html += `<td colspan="2" style="text-align: center; font-size: 0.75rem; color: var(--text-secondary);">${icon} ${event}</td>`;
            }
            html += '</tr>';
            
            // Then product rows
            PRODUCTS.forEach(p => {
                html += `<tr><td>${p.short}</td>`;
                for (let w = 1; w <= 3; w++) {
                    const data = getSameWeekdayData(currentDate, w).find(d => d.product === p.name);
                    html += `<td>${data?.totaal || 0}</td><td class="breuk">${data?.breuk ?? '-'}</td>`;
                }
                html += '</tr>';
            });
            document.getElementById('reference-body').innerHTML = html;
        }
        
        function onInput(input) {
            const id = input.dataset.id;
            const field = input.dataset.field;
            const value = parseInt(input.value) || 0;
            const row = input.closest('tr');
            
            if (!planningData[id]) planningData[id] = {};
            
            if (field === 'totaal') {
                // User changed total - store it, batches will be recalculated
                planningData[id] = { totaal: value };
                // Clear batch overrides so they get recalculated
            } else {
                // User changed a batch - update only totaal, keep all batches as user set them
                const l1 = parseInt(row.querySelector('[data-field="l1"]').value) || 0;
                const l2 = parseInt(row.querySelector('[data-field="l2"]').value) || 0;
                const l3 = parseInt(row.querySelector('[data-field="l3"]').value) || 0;
                const l4 = parseInt(row.querySelector('[data-field="l4"]').value) || 0;
                const l5 = parseInt(row.querySelector('[data-field="l5"]').value) || 0;
                
                planningData[id] = {
                    totaal: l1 + l2 + l3 + l4 + l5,
                    l1, l2, l3, l4, l5
                };
                
                // Update only the totaal display for this row, don't re-render everything
                const totaalInput = row.querySelector('[data-field="totaal"]');
                totaalInput.value = planningData[id].totaal;
                
                // Update group total row
                updateGroupTotals();
                
                // Update lading totals
                updateLadingTotals();
                
                // Mark as unsaved
                markUnsaved();
                return; // Don't call full renderPlanning
            }
            
            // Mark as unsaved
            markUnsaved();
            
            renderPlanning();
        }
        
        function updateGroupTotals() {
            ['A', 'B'].forEach(group => {
                const body = document.getElementById(`group-${group.toLowerCase()}-body`);
                const rows = body.querySelectorAll('tr:not(.total-row)');
                let totals = { sug: 0, totaal: 0, l1: 0, l2: 0, l3: 0, l4: 0, l5: 0 };
                
                rows.forEach(row => {
                    totals.sug += parseInt(row.querySelector('.sug-value')?.textContent) || 0;
                    totals.totaal += parseInt(row.querySelector('[data-field="totaal"]')?.value) || 0;
                    totals.l1 += parseInt(row.querySelector('[data-field="l1"]')?.value) || 0;
                    totals.l2 += parseInt(row.querySelector('[data-field="l2"]')?.value) || 0;
                    totals.l3 += parseInt(row.querySelector('[data-field="l3"]')?.value) || 0;
                    totals.l4 += parseInt(row.querySelector('[data-field="l4"]')?.value) || 0;
                    totals.l5 += parseInt(row.querySelector('[data-field="l5"]')?.value) || 0;
                });
                
                const totalRow = body.querySelector('.total-row');
                if (totalRow) {
                    const cells = totalRow.querySelectorAll('td');
                    cells[1].textContent = totals.sug;
                    cells[2].textContent = totals.totaal;
                    cells[3].textContent = totals.l1;
                    cells[4].textContent = totals.l2;
                    cells[5].textContent = totals.l3;
                    cells[6].textContent = totals.l4;
                    cells[7].textContent = totals.l5;
                }
            });
        }
        
        function updateLadingTotals() {
            for (let i = 1; i <= 5; i++) {
                let total = 0;
                document.querySelectorAll(`input[data-field="l${i}"]`).forEach(inp => {
                    total += parseInt(inp.value) || 0;
                });
                const el = document.getElementById(`lading-l${i}`);
                el.textContent = total;
                el.parentElement.className = 'lading-item' + (total > SETTINGS.batchMax ? ' danger' : total > 25 ? ' warning' : '');
            }
        }
        
        // ===== SAVE STATE TRACKING =====
        let hasUnsavedChanges = false;
        
        function onEventChange() {
            planningData._eventEdited = true;
            markUnsaved();
        }
        
        function markUnsaved() {
            hasUnsavedChanges = true;
            const btn = document.getElementById('save-btn');
            btn.classList.remove('saved');
            btn.classList.add('unsaved');
            btn.querySelector('span').textContent = 'Niet opgeslagen!';
        }
        
        function markSaved() {
            hasUnsavedChanges = false;
            const btn = document.getElementById('save-btn');
            btn.classList.remove('unsaved');
            btn.classList.add('saved');
            btn.querySelector('span').textContent = 'Opgeslagen ‚úì';
            
            // Reset to neutral after 3 seconds
            setTimeout(() => {
                if (!hasUnsavedChanges) {
                    btn.classList.remove('saved');
                    btn.querySelector('span').textContent = 'Opslaan';
                }
            }, 3000);
        }
        
        // ===== BREUK =====
        function renderBreukPage() {
            const select = document.getElementById('breuk-date-select');
            const dates = [...new Set(historicalData.map(d => d.datum))].sort().reverse();
            select.innerHTML = dates.slice(0, 14).map(d => {
                const dt = new Date(d);
                return `<option value="${d}">${formatDate(dt)} (${getDayName(dt)})</option>`;
            }).join('');
            loadBreukData();
        }
        
        function loadBreukData() {
            const dateStr = document.getElementById('breuk-date-select').value;
            const dayData = historicalData.filter(d => d.datum === dateStr);
            
            document.getElementById('breuk-grid').innerHTML = PRODUCTS.map(p => {
                const data = dayData.find(d => d.product === p.name);
                return `<div class="breuk-item">
                    <div><div class="product-name">${p.name}</div>
                    <div class="product-baked">Gebakken: ${data?.totaal || 0} platen</div></div>
                    <input type="number" value="${data?.breuk ?? ''}" data-product="${p.name}" placeholder="0">
                </div>`;
            }).join('');
        }
        
        function saveBreuk() {
            const dateStr = document.getElementById('breuk-date-select').value;
            document.querySelectorAll('#breuk-grid input').forEach(inp => {
                const rec = historicalData.find(d => d.datum === dateStr && d.product === inp.dataset.product);
                if (rec) rec.breuk = parseInt(inp.value) || 0;
            });
            localStorage.setItem('bakkerij_data', JSON.stringify(historicalData));
            if (supabaseClient) syncToSupabase();
            showToast('‚úÖ Breuk opgeslagen!');
        }
        
        // ===== HISTORIEK =====
        let historyRange = 7; // Default to 7 days
        let customDateFrom = null;
        let customDateTo = null;
        
        function setHistoryRange(range) {
            historyRange = range;
            // Update button states
            document.querySelectorAll('.range-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.range == range);
            });
            
            // Show/hide custom date inputs
            const customDiv = document.getElementById('custom-date-range');
            if (range === 'custom') {
                customDiv.style.display = 'block';
                // Set default dates if not set
                if (!document.getElementById('history-date-from').value) {
                    const fromDate = new Date();
                    fromDate.setDate(fromDate.getDate() - 7);
                    document.getElementById('history-date-from').value = formatDateISO(fromDate);
                    document.getElementById('history-date-to').value = formatDateISO(new Date());
                }
                applyCustomDateRange();
            } else {
                customDiv.style.display = 'none';
                renderHistoriek();
            }
        }
        
        function applyCustomDateRange() {
            customDateFrom = document.getElementById('history-date-from').value;
            customDateTo = document.getElementById('history-date-to').value;
            renderHistoriek();
        }
        
        function getFilteredData() {
            if (historyRange === 'all') return historicalData;
            
            if (historyRange === 'custom' && customDateFrom && customDateTo) {
                return historicalData.filter(d => d.datum >= customDateFrom && d.datum <= customDateTo);
            }
            
            const cutoff = new Date();
            cutoff.setDate(cutoff.getDate() - historyRange);
            const cutoffStr = formatDateISO(cutoff);
            
            return historicalData.filter(d => d.datum >= cutoffStr);
        }
        
        function renderHistoriek() {
            const filteredData = getFilteredData();
            
            let gebakken = 0, breuk = 0;
            const stats = {};
            PRODUCTS.forEach(p => stats[p.name] = { gebakken: 0, breuk: 0 });
            
            filteredData.forEach(d => {
                const p = PRODUCTS.find(x => x.name === d.product);
                if (p) {
                    const stuks = d.totaal * p.ppp;
                    stats[d.product].gebakken += stuks;
                    stats[d.product].breuk += d.breuk || 0;
                    gebakken += stuks;
                    breuk += d.breuk || 0;
                }
            });
            
            // Calculate total omzet
            let totalOmzet = 0;
            PRODUCTS.forEach(p => {
                const verkocht = stats[p.name].gebakken - stats[p.name].breuk;
                const price = p.group === 'A' ? SETTINGS.priceA : SETTINGS.priceB;
                stats[p.name].omzet = verkocht * price;
                totalOmzet += stats[p.name].omzet;
            });
            
            document.getElementById('stat-gebakken').textContent = gebakken.toLocaleString();
            document.getElementById('stat-breuk').textContent = breuk.toLocaleString();
            document.getElementById('stat-verkocht').textContent = (gebakken - breuk).toLocaleString();
            document.getElementById('stat-percentage').textContent = gebakken > 0 ? (breuk / gebakken * 100).toFixed(1) + '%' : '0%';
            document.getElementById('stat-omzet').textContent = '‚Ç¨' + totalOmzet.toFixed(2).replace('.', ',');
            
            document.getElementById('history-body').innerHTML = PRODUCTS.map(p => {
                const s = stats[p.name];
                const verkocht = s.gebakken - s.breuk;
                const pct = s.gebakken > 0 ? (s.breuk / s.gebakken * 100).toFixed(1) : 0;
                return `<tr><td>${p.name}</td><td>${s.gebakken}</td><td style="color:var(--accent-green)">${verkocht}</td><td style="color:var(--accent-green)">‚Ç¨${s.omzet.toFixed(2)}</td><td style="color:var(--accent-red)">${s.breuk}</td><td>${pct}%</td></tr>`;
            }).join('');
            
            drawChart();
        }
        
        function drawChart() {
            const canvas = document.getElementById('chart-canvas');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            const rect = canvas.parentElement.getBoundingClientRect();
            canvas.width = rect.width * 2;
            canvas.height = rect.height * 2;
            ctx.scale(2, 2);
            
            const width = rect.width, height = rect.height;
            const pad = { top: 15, right: 10, bottom: 25, left: 35 };
            
            const filteredData = getFilteredData();
            
            // Get selected product filter
            const selectedProduct = document.getElementById('chart-product-select')?.value || 'all';
            const selectedProductName = selectedProduct !== 'all' 
                ? PRODUCTS.find(p => p.id === selectedProduct)?.name 
                : null;
            
            const dates = [...new Set(filteredData.map(d => d.datum))].sort();
            const daily = dates.map(date => {
                const recs = filteredData.filter(d => d.datum === date);
                let geb = 0, brk = 0;
                recs.forEach(r => {
                    // If a product is selected, only show that product
                    if (selectedProductName && r.product !== selectedProductName) return;
                    
                    const p = PRODUCTS.find(x => x.name === r.product);
                    if (p) { geb += r.totaal * p.ppp; brk += r.breuk || 0; }
                });
                return { date, geb, brk };
            });
            
            if (!daily.length) {
                ctx.fillStyle = '#64748b';
                ctx.font = '12px Plus Jakarta Sans';
                ctx.textAlign = 'center';
                ctx.fillText('Geen data', width/2, height/2);
                return;
            }
            
            const maxVal = Math.max(...daily.map(d => d.geb), 100);
            ctx.clearRect(0, 0, width, height);
            
            // Grid
            ctx.strokeStyle = '#334155';
            ctx.lineWidth = 1;
            for (let i = 0; i <= 4; i++) {
                const y = pad.top + (height - pad.top - pad.bottom) * (i / 4);
                ctx.beginPath(); ctx.moveTo(pad.left, y); ctx.lineTo(width - pad.right, y); ctx.stroke();
                ctx.fillStyle = '#64748b';
                ctx.font = '9px JetBrains Mono';
                ctx.textAlign = 'right';
                ctx.fillText(Math.round(maxVal * (1 - i/4)), pad.left - 4, y + 3);
            }
            
            const chartW = width - pad.left - pad.right;
            const chartH = height - pad.top - pad.bottom;
            const spacing = chartW / Math.max(daily.length - 1, 1);
            
            // Lines
            [[daily.map(d => d.geb), '#10b981'], [daily.map(d => d.brk), '#ef4444']].forEach(([vals, color]) => {
                ctx.strokeStyle = color;
                ctx.lineWidth = 2;
                ctx.beginPath();
                vals.forEach((v, i) => {
                    const x = pad.left + i * spacing;
                    const y = pad.top + chartH * (1 - v / maxVal);
                    i === 0 ? ctx.moveTo(x, y) : ctx.lineTo(x, y);
                });
                ctx.stroke();
                
                ctx.fillStyle = color;
                vals.forEach((v, i) => {
                    const x = pad.left + i * spacing;
                    const y = pad.top + chartH * (1 - v / maxVal);
                    ctx.beginPath(); ctx.arc(x, y, 3, 0, Math.PI * 2); ctx.fill();
                });
            });
            
            // X labels
            ctx.fillStyle = '#64748b';
            ctx.font = '8px JetBrains Mono';
            ctx.textAlign = 'center';
            daily.forEach((d, i) => {
                if (i % 2 === 0 || daily.length <= 7) {
                    const x = pad.left + i * spacing;
                    const dt = new Date(d.date);
                    ctx.fillText(`${dt.getDate()}/${dt.getMonth()+1}`, x, height - 5);
                }
            });
        }
        
        // ===== SETTINGS =====
        function renderSettings() {
            // PPP settings
            document.getElementById('ppp-settings').innerHTML = PRODUCTS.map(p => `
                <div class="setting-row">
                    <label style="font-size: 0.85rem;">${p.name}</label>
                    <input type="number" value="${p.ppp}" data-id="${p.id}" data-field="ppp" onchange="updateProductSetting(this)" style="width: 50px;">
                </div>
            `).join('');
            
            // Drempel settings
            document.getElementById('drempel-settings').innerHTML = PRODUCTS.map(p => `
                <tr>
                    <td style="font-size: 0.7rem;">${p.short}</td>
                    <td><input type="number" value="${p.bij0}" data-id="${p.id}" data-field="bij0" onchange="updateProductSetting(this)" style="width: 32px;"></td>
                    <td><input type="number" value="${p.d1}" data-id="${p.id}" data-field="d1" onchange="updateProductSetting(this)" style="width: 32px;"></td>
                    <td><input type="number" value="${p.d2}" data-id="${p.id}" data-field="d2" onchange="updateProductSetting(this)" style="width: 32px;"></td>
                    <td><input type="number" value="${p.d3}" data-id="${p.id}" data-field="d3" onchange="updateProductSetting(this)" style="width: 32px;"></td>
                </tr>
            `).join('');
        }
        
        function updateProductSetting(input) {
            const id = input.dataset.id;
            const field = input.dataset.field;
            const value = parseInt(input.value) || 0;
            const product = PRODUCTS.find(p => p.id === id);
            if (product) {
                product[field] = value;
                localStorage.setItem('bakkerij_products', JSON.stringify(PRODUCTS));
                showToast('‚öôÔ∏è Instelling opgeslagen');
            }
        }
        
        function saveCapacitySettings() {
            SETTINGS.oven1Max = parseInt(document.getElementById('setting-oven1').value) || 16;
            SETTINGS.oven2Max = parseInt(document.getElementById('setting-oven2').value) || 15;
            SETTINGS.batchMax = parseInt(document.getElementById('setting-batch-max').value) || 31;
            SETTINGS.skipBInL2 = document.getElementById('setting-skip-b').checked;
            localStorage.setItem('bakkerij_settings', JSON.stringify(SETTINGS));
            planningData = {}; // Reset manual overrides so new settings apply
            renderPlanning();
            showToast('‚öôÔ∏è Capaciteit opgeslagen');
        }
        
        function savePriceSettings() {
            SETTINGS.priceA = parseFloat(document.getElementById('setting-price-a').value) || 0.69;
            SETTINGS.priceB = parseFloat(document.getElementById('setting-price-b').value) || 1.59;
            // Update product prices
            PRODUCTS.forEach(p => {
                p.price = p.group === 'A' ? SETTINGS.priceA : SETTINGS.priceB;
            });
            localStorage.setItem('bakkerij_settings', JSON.stringify(SETTINGS));
            showToast('üí∞ Prijzen opgeslagen');
        }
        
        // ===== SAVE =====
        function savePlanning() {
            const dateStr = formatDateISO(currentDate);
            const event = document.getElementById('event-select').value;
            const weather = document.getElementById('weather-badge').innerHTML;
            
            historicalData = historicalData.filter(d => d.datum !== dateStr);
            
            PRODUCTS.forEach(p => {
                const row = document.querySelector(`input[data-id="${p.id}"]`).closest('tr');
                const data = {
                    datum: dateStr, product: p.name, event, weather,
                    totaal: parseInt(row.querySelector('[data-field="totaal"]').value) || 0,
                    l1: parseInt(row.querySelector('[data-field="l1"]').value) || 0,
                    l2: parseInt(row.querySelector('[data-field="l2"]').value) || 0,
                    l3: parseInt(row.querySelector('[data-field="l3"]').value) || 0,
                    l4: parseInt(row.querySelector('[data-field="l4"]').value) || 0,
                    l5: parseInt(row.querySelector('[data-field="l5"]').value) || 0,
                    breuk: null
                };
                historicalData.push(data);
            });
            
            historicalData.sort((a, b) => b.datum.localeCompare(a.datum));
            localStorage.setItem('bakkerij_data', JSON.stringify(historicalData));
            if (supabaseClient) syncToSupabase();
            markSaved();
            showToast(`‚úÖ Planning voor ${formatDate(currentDate)} opgeslagen!`);
            renderBreukPage();
        }
        
        function changeDate(delta) {
            // Warn if unsaved changes
            if (hasUnsavedChanges) {
                if (!confirm('‚ö†Ô∏è Je hebt niet-opgeslagen wijzigingen!\n\nWil je toch doorgaan?')) {
                    return;
                }
            }
            
            currentDate.setDate(currentDate.getDate() + delta);
            planningData = {};
            hasUnsavedChanges = false;
            const btn = document.getElementById('save-btn');
            btn.classList.remove('unsaved', 'saved');
            btn.querySelector('span').textContent = 'Opslaan';
            updateHeader();
            renderPlanning();
            updateWeather();
        }
        
        // ===== WEATHER =====
        // Aarschot, Belgium coordinates
        const WEATHER_LAT = 50.9867;
        const WEATHER_LON = 4.8307;
        let weatherCache = {};
        
        async function updateWeather() {
            const dateStr = formatDateISO(currentDate);
            const badge = document.getElementById('weather-badge');
            
            // Check if we have saved weather for this date
            const savedDayData = historicalData.filter(d => d.datum === dateStr);
            if (savedDayData.length > 0 && savedDayData[0].weather) {
                badge.innerHTML = savedDayData[0].weather;
                return;
            }
            
            // Check cache
            if (weatherCache[dateStr]) {
                badge.innerHTML = weatherCache[dateStr];
                return;
            }
            
            // Only fetch for dates within forecast range (16 days)
            const today = new Date();
            const diffDays = Math.ceil((currentDate - today) / (1000 * 60 * 60 * 24));
            
            if (diffDays < -1 || diffDays > 14) {
                badge.innerHTML = 'üìÖ --';
                badge.title = 'Geen weerdata beschikbaar';
                return;
            }
            
            badge.innerHTML = '‚è≥';
            
            try {
                const response = await fetch(
                    `https://api.open-meteo.com/v1/forecast?latitude=${WEATHER_LAT}&longitude=${WEATHER_LON}&daily=weather_code,temperature_2m_max,temperature_2m_min&timezone=Europe/Brussels&start_date=${dateStr}&end_date=${dateStr}`
                );
                const data = await response.json();
                
                if (data.daily && data.daily.weather_code) {
                    const code = data.daily.weather_code[0];
                    const maxTemp = Math.round(data.daily.temperature_2m_max[0]);
                    const minTemp = Math.round(data.daily.temperature_2m_min[0]);
                    const icon = getWeatherIcon(code);
                    const weatherStr = `${icon} ${maxTemp}¬∞`;
                    
                    badge.innerHTML = weatherStr;
                    badge.title = `${getWeatherDescription(code)} (${minTemp}¬∞-${maxTemp}¬∞)`;
                    weatherCache[dateStr] = weatherStr;
                } else {
                    badge.innerHTML = '‚ùì';
                }
            } catch (e) {
                badge.innerHTML = '‚ùå';
                badge.title = 'Weer ophalen mislukt';
            }
        }
        
        function getWeatherIcon(code) {
            // WMO Weather codes: https://open-meteo.com/en/docs
            if (code === 0) return '‚òÄÔ∏è'; // Clear
            if (code <= 3) return '‚õÖ'; // Partly cloudy
            if (code <= 49) return 'üå´Ô∏è'; // Fog
            if (code <= 59) return 'üåßÔ∏è'; // Drizzle
            if (code <= 69) return 'üåßÔ∏è'; // Rain
            if (code <= 79) return '‚ùÑÔ∏è'; // Snow
            if (code <= 84) return 'üåßÔ∏è'; // Rain showers
            if (code <= 86) return 'üå®Ô∏è'; // Snow showers
            if (code >= 95) return '‚õàÔ∏è'; // Thunderstorm
            return 'üå•Ô∏è';
        }
        
        function getWeatherDescription(code) {
            if (code === 0) return 'Helder';
            if (code <= 3) return 'Gedeeltelijk bewolkt';
            if (code <= 49) return 'Mist';
            if (code <= 59) return 'Motregen';
            if (code <= 69) return 'Regen';
            if (code <= 79) return 'Sneeuw';
            if (code <= 84) return 'Regenbuien';
            if (code <= 86) return 'Sneeuwbuien';
            if (code >= 95) return 'Onweer';
            return 'Bewolkt';
        }
        
        // ===== SUPABASE =====
        async function initSupabase() {
            if (!window.supabase) {
                document.getElementById('db-status').textContent = 'üî¥ Supabase library niet geladen';
                return;
            }
            
            try {
                supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
                const { error } = await supabaseClient.from('planning_data').select('id').limit(1);
                
                if (error) {
                    document.getElementById('db-status').textContent = 'üî¥ ' + error.message.substring(0, 40);
                } else {
                    document.getElementById('db-status').textContent = 'üü¢ Verbonden met cloud';
                    await loadFromSupabase();
                }
            } catch (e) {
                document.getElementById('db-status').textContent = 'üî¥ Connectie mislukt';
            }
        }
        
        async function loadFromSupabase() {
            if (!supabaseClient) return;
            const { data } = await supabaseClient.from('planning_data').select('*').order('datum', { ascending: false });
            if (data?.length) {
                historicalData = data;
                localStorage.setItem('bakkerij_data', JSON.stringify(historicalData));
                renderPlanning();
            }
        }
        
        async function syncToSupabase() {
            if (!supabaseClient) return;
            for (const rec of historicalData) {
                await supabaseClient.from('planning_data').upsert({
                    datum: rec.datum, product: rec.product, totaal: rec.totaal,
                    l1: rec.l1, l2: rec.l2, l3: rec.l3, l4: rec.l4, l5: rec.l5,
                    breuk: rec.breuk, event: rec.event
                }, { onConflict: 'datum,product' });
            }
        }
        
        // ===== TABS =====
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
                tab.classList.add('active');
                document.getElementById(`page-${tab.dataset.page}`).classList.add('active');
                
                if (tab.dataset.page === 'breuk') renderBreukPage();
                if (tab.dataset.page === 'historiek') renderHistoriek();
                if (tab.dataset.page === 'instellingen') renderSettings();
            });
        });
        
        // ===== INIT =====
        async function init() {
            // Load historical data
            const saved = localStorage.getItem('bakkerij_data');
            historicalData = saved ? JSON.parse(saved) : [...INITIAL_DATA];
            
            // Load settings
            const savedSettings = localStorage.getItem('bakkerij_settings');
            if (savedSettings) SETTINGS = { ...SETTINGS, ...JSON.parse(savedSettings) };
            
            // Load product settings (ppp, drempels)
            const savedProducts = localStorage.getItem('bakkerij_products');
            if (savedProducts) {
                const prods = JSON.parse(savedProducts);
                prods.forEach(saved => {
                    const p = PRODUCTS.find(x => x.id === saved.id);
                    if (p) {
                        p.ppp = saved.ppp ?? p.ppp;
                        p.bij0 = saved.bij0 ?? p.bij0;
                        p.d1 = saved.d1 ?? p.d1;
                        p.d2 = saved.d2 ?? p.d2;
                        p.d3 = saved.d3 ?? p.d3;
                    }
                });
            }
            
            // Auto-set date to next unsaved date
            const savedDates = [...new Set(historicalData.map(d => d.datum))].sort();
            if (savedDates.length > 0) {
                // Find the last saved date and go to next day
                const lastSaved = new Date(savedDates[savedDates.length - 1]);
                lastSaved.setDate(lastSaved.getDate() + 1);
                currentDate = lastSaved;
            } else {
                currentDate = new Date();
            }
            
            document.getElementById('setting-oven1').value = SETTINGS.oven1Max;
            document.getElementById('setting-oven2').value = SETTINGS.oven2Max;
            document.getElementById('setting-batch-max').value = SETTINGS.batchMax;
            document.getElementById('setting-skip-b').checked = SETTINGS.skipBInL2;
            document.getElementById('setting-price-a').value = SETTINGS.priceA || 0.69;
            document.getElementById('setting-price-b').value = SETTINGS.priceB || 1.59;
            
            // Update product prices from settings
            PRODUCTS.forEach(p => {
                p.price = p.group === 'A' ? SETTINGS.priceA : SETTINGS.priceB;
            });
            
            updateHeader();
            renderPlanning();
            updateWeather();
            await initSupabase();
        }
        
        init();
    </script>
</body>
</html>
